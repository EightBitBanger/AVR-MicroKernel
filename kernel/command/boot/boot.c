#include <kernel/kernel.h>

#include <kernel/command/boot/boot.h>

void DropFileSystemFunc(void);
void DropDeviceDrivers(void);

void functionBoot(uint8_t* param, uint8_t param_length) {
    
    if ((param[0] == '-') & 
        (param[1] == 'f') & 
        (param[2] == 'o') & 
        (param[3] == 'r') & 
        (param[4] == 'm') & 
        (param[5] == 'a') & 
        (param[6] == 't')) {
        
        uint8_t msgFormatting[] = "Formatting...";
        print(msgFormatting, sizeof(msgFormatting));
        printLn();
        
        uint32_t deviceCapacity = fsDeviceGetCapacity();
        
        if (deviceCapacity < FORMAT_CAPACITY_8K) 
            deviceCapacity = FORMAT_CAPACITY_8K;
        
        if (deviceCapacity > FORMAT_CAPACITY_32K) 
            deviceCapacity = FORMAT_CAPACITY_32K;
        
        fsFormat(0, deviceCapacity);
        
        fsWorkingDirectoryClear();
    }
    
    if ((param[0] == '-') & 
        (param[1] == 'b') & 
        (param[2] == 'i') & 
        (param[3] == 'n')) {
        
        // Create 'bin' directory on the root
        uint8_t msgCreatingBins[] = "Creating binaries";
        print(msgCreatingBins, sizeof(msgCreatingBins));
        printLn();
        
        uint8_t dirNameBin[] = "bin";
        uint32_t dirBinAddress = fsDirectoryExists(dirNameBin, sizeof(dirNameBin)-1);
        if (dirBinAddress == 0) {
            dirBinAddress = fsDirectoryCreate(dirNameBin, sizeof(dirNameBin));
            if (dirBinAddress == 0) 
                return;
        }
        
        // Drop the binary files
        fsWorkingDirectoryChange(dirNameBin, sizeof(dirNameBin));
        DropFileSystemFunc();
        fsWorkingDirectoryClear();
        
    }
    
    if ((param[0] == '-') & 
        (param[1] == 's') & 
        (param[2] == 'y') & 
        (param[3] == 's')) {
        
        // Create 'sys' directory on the root
        uint8_t msgCreatingDrivers[] = "Creating drivers";
        print(msgCreatingDrivers, sizeof(msgCreatingDrivers));
        printLn();
        
        uint8_t dirNameSys[] = "sys";
        uint32_t dirSysAddress = fsDirectoryExists(dirNameSys, sizeof(dirNameSys)-1);
        if (dirSysAddress == 0) 
            dirSysAddress = fsDirectoryCreate(dirNameSys, sizeof(dirNameSys));
        
        fsWorkingDirectoryChange(dirNameSys, sizeof(dirNameSys));
        DropDeviceDrivers();
        
        fsWorkingDirectoryClear();
        
    }
    
    return;
}

void registerCommandBoot(void) {
    
    uint8_t bootCommandName[] = "boot";
    
    ConsoleRegisterCommand(bootCommandName, sizeof(bootCommandName), functionBoot);
    
    return;
}





void DropFileSystemFunc(void) {
    
    {
    uint8_t filename[]  = "net";
    uint8_t program[] = {
    0x89, 0x00, 0x00, 0x89, 0x01, 0x0A, 0xCD, 0x14, 0x38, 0x02, 0x01, 0x74, 0x2B, 0x00, 0x00, 0x00, 0x38, 0x02, 0x02, 0x74, 0x38, 0x00, 0x00, 0x00, 
    0x83, 0x06, 0x45, 0x00, 0x00, 0x00, 0x89, 0x04, 0x0C, 0x89, 0x00, 0x01, 0x89, 0x01, 0x0C, 0xCD, 0x14, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 
    0x51, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x62, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x74, 0x65, 0x73, 
    0x74, 0x20, 0x70, 0x61, 0x63, 0x6B, 0x65, 0x74, 0x00, 0x49, 0x6E, 0x69, 0x74, 0x69, 0x61, 0x74, 0x69, 0x6F, 0x6E, 0x20, 0x65, 0x72, 0x72, 0x6F, 
    0x72, 0x00, 0x4E, 0x65, 0x74, 0x77, 0x6F, 0x72, 0x6B, 0x20, 0x64, 0x72, 0x69, 0x65, 0x72, 0x20, 0x65, 0x72, 0x72, 0x6F, 0x72, 0x00, 
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    {
    uint8_t filename[]  = "ld";
    uint8_t program[] = {
        0x89, 0x01, 0x0A, 0xCD, 0x47, 0x38, 0x02, 0x01, 0x74, 0x37, 0x00, 0x00, 0x00, 0x38, 0x02, 0x02, 0x74, 0x44, 0x00, 0x00, 0x00, 0x38, 0x02, 0x03, 
        0x74, 0x2A, 0x00, 0x00, 0x00, 0x89, 0x01, 0x09, 0x83, 0x06, 0x51, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x58, 
        0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x67, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 
        0x06, 0x7B, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x4C, 0x6F, 0x61, 0x64, 0x65, 0x64, 0x00, 0x41, 0x6C, 0x72, 0x65, 0x61, 0x64, 0x79, 0x20, 
        0x6C, 0x6F, 0x61, 0x64, 0x65, 0x64, 0x00, 0x46, 0x69, 0x6C, 0x65, 0x20, 0x64, 0x6F, 0x65, 0x73, 0x20, 0x6E, 0x6F, 0x74, 0x20, 0x65, 0x78, 0x69, 
        0x73, 0x74, 0x00, 0x46, 0x69, 0x6C, 0x65, 0x20, 0x63, 0x6F, 0x72, 0x72, 0x75, 0x70, 0x74, 0x00, 0xCD, 0x20
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    
    {
    uint8_t filename[]  = "type";
    uint8_t program[] = {
        0x89, 0x01, 0x4C, 0xCD, 0x13, 0xCD, 0x20, 
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    
    {
    uint8_t filename[]  = "ver";
    uint8_t program[] = {
        0x89, 0x01, 0x09, 0x83, 0x06, 0x0D, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x56, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x20, 0x30, 0x2E, 0x31, 0x2E, 0x30, 0x00 
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    
    {
    uint8_t filename[]  = "cls";
    uint8_t program[] = {
        0x89, 0x01, 0x03, 0xCD, 0x10, 0xCD, 0x20, 
    };
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    
    {
    uint8_t filename[]  = "ld";
    uint8_t program[] = {
        0x89, 0x01, 0x0A, 0xCD, 0x47, 0x38, 0x02, 0x01, 0x74, 0x2F, 0x00, 0x00, 0x00, 0x38, 0x02, 0x02, 0x74, 0x3C, 0x00, 0x00, 0x00, 0x38, 0x02, 0x03, 
        0x74, 0x22, 0x00, 0x00, 0x00, 0xFE, 0x79, 0x00, 0x00, 0x00, 0x89, 0x01, 0x09, 0x83, 0x06, 0x49, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 
        0x01, 0x09, 0x83, 0x06, 0x58, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x6C, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 
        0x20, 0x41, 0x6C, 0x72, 0x65, 0x61, 0x64, 0x79, 0x20, 0x6C, 0x6F, 0x61, 0x64, 0x65, 0x64, 0x00, 0x46, 0x69, 0x6C, 0x65, 0x20, 0x64, 0x6F, 0x65, 
        0x73, 0x20, 0x6E, 0x6F, 0x74, 0x20, 0x65, 0x78, 0x69, 0x73, 0x74, 0x00, 0x46, 0x69, 0x6C, 0x65, 0x20, 0x63, 0x6F, 0x72, 0x72, 0x75, 0x70, 0x74, 
        0x00, 0xCD, 0x20, 
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    
    {
    uint8_t filename[]  = "mk";
    uint8_t program[] = {
        0x89, 0x01, 0x3C, 0x89, 0x04, 0x00, 0x89, 0x05, 0x14, 0xCD, 0x13, 0x38, 0x02, 0x00, 0x74, 0x2B, 0x00, 0x00, 0x00, 0x38, 0x02, 0x01, 0x74, 0x47, 
        0x00, 0x00, 0x00, 0x38, 0x02, 0x02, 0x74, 0x3A, 0x00, 0x00, 0x00, 0x38, 0x02, 0x03, 0x74, 0x2D, 0x00, 0x00, 0x00, 0xCD, 0x20, 0x89, 0x01, 0x09, 
        0x83, 0x06, 0x54, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x68, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 
        0x01, 0x09, 0x83, 0x06, 0x7C, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x45, 0x72, 0x72, 0x6F, 0x72, 0x20, 0x63, 0x72, 0x65, 0x61, 0x74, 0x69, 
        0x6E, 0x67, 0x20, 0x66, 0x69, 0x6C, 0x65, 0x00, 0x46, 0x69, 0x6C, 0x65, 0x20, 0x61, 0x6C, 0x72, 0x65, 0x61, 0x64, 0x79, 0x20, 0x65, 0x78, 0x69, 
        0x73, 0x74, 0x73, 0x00, 0x42, 0x61, 0x64, 0x20, 0x66, 0x69, 0x6C, 0x65, 0x6E, 0x61, 0x6D, 0x65, 0x00, 
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    
    {
    uint8_t filename[]  = "mkdir";
    uint8_t program[] = {
        0x89, 0x01, 0x39, 0xCD, 0x13, 0x38, 0x02, 0x00, 0x74, 0x25, 0x00, 0x00, 0x00, 0x38, 0x02, 0x01, 0x74, 0x41, 0x00, 0x00, 0x00, 0x38, 0x02, 0x02, 
        0x74, 0x34, 0x00, 0x00, 0x00, 0x38, 0x02, 0x03, 0x74, 0x27, 0x00, 0x00, 0x00, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x4E, 0x00, 0x00, 0x00, 
        0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x61, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x74, 0x00, 
        0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x45, 0x72, 0x72, 0x6F, 0x72, 0x20, 0x63, 0x72, 0x65, 0x61, 0x74, 0x69, 0x6E, 0x67, 0x20, 0x64, 0x69, 0x72, 
        0x00, 0x44, 0x69, 0x72, 0x20, 0x61, 0x6C, 0x72, 0x65, 0x61, 0x64, 0x79, 0x20, 0x65, 0x78, 0x69, 0x73, 0x74, 0x73, 0x00, 0x42, 0x61, 0x64, 0x20, 
        0x64, 0x69, 0x72, 0x20, 0x6E, 0x61, 0x6D, 0x65, 0x00, 
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    
    
    {
    uint8_t filename[]  = "rm";
    uint8_t program[] = {
        0x89, 0x01, 0x41, 0xCD, 0x13, 0x38, 0x02, 0x00, 0x74, 0x2F, 0x00, 0x00, 0x00, 0x38, 0x02, 0x01, 0x74, 0x3E, 0x00, 0x00, 0x00, 0x89, 0x01, 0x3A, 
        0xCD, 0x13, 0x38, 0x02, 0x00, 0x74, 0x2F, 0x00, 0x00, 0x00, 0x38, 0x02, 0x01, 0x74, 0x3E, 0x00, 0x00, 0x00, 0xFE, 0x31, 0x00, 0x00, 0x00, 0xCD, 
        0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x4B, 0x00, 0x00, 0x00, 0xCD, 0x10, 0xCD, 0x20, 0x89, 0x01, 0x09, 0x83, 0x06, 0x71, 0x00, 0x00, 0x00, 0xCD, 
        0x10, 0xCD, 0x20, 0x45, 0x72, 0x72, 0x6F, 0x72, 0x20, 0x64, 0x65, 0x6C, 0x65, 0x74, 0x69, 0x6E, 0x67, 0x20, 0x64, 0x69, 0x72, 0x00, 0x44, 0x69, 
        0x72, 0x20, 0x61, 0x6C, 0x72, 0x65, 0x61, 0x64, 0x79, 0x20, 0x65, 0x78, 0x69, 0x73, 0x74, 0x73, 0x00, 0x42, 0x61, 0x64, 0x20, 0x64, 0x69, 0x72, 
        0x20, 0x6E, 0x61, 0x6D, 0x65, 0x00, 
    };
    
    uint32_t fileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (fileAddress == 0) {
        fileAddress = fsFileCreate(filename, sizeof(filename), sizeof(program));
        
        struct FSAttribute attrib = {'x', 'r', 'w', ' '};
        fsFileSetAttributes(fileAddress, &attrib);
        
        int32_t index = fsFileOpen(fileAddress);
        fsFileWrite(index, program, sizeof(program));
        fsFileClose(index);
    }
    }
    
    return;
}



void DropDeviceDrivers(void) {
    
    // NIC - Network interface controller driver
    {
    uint8_t filename[]  = "nic";
    uint32_t nicFileAddress = fsFileExists(filename, sizeof(filename)-1);
    if (nicFileAddress == 0) {
        nicFileAddress = fsFileCreate(filename, sizeof(filename), 30);
        
        int32_t index = fsFileOpen(nicFileAddress);
        uint8_t bufferDrvNic[128] = "  network   $irwtxxxx";
        
        bufferDrvNic[0] = 'K';      // Marker bytes KD (kernel driver)
        bufferDrvNic[1] = 'D';
        
        // Next 10 bytes reserved for driver name
        
        bufferDrvNic[12] = '$';   // Marker byte '$'
        bufferDrvNic[13] = 0x14;  // Device ID
        bufferDrvNic[14] = 10;    // Bus read wait-state
        bufferDrvNic[15] = 10;    // Bus write wait-state
        bufferDrvNic[16] = 2;     // Bus interface type
        
        bufferDrvNic[17] = 0x00;  // Zero the hardware address
        bufferDrvNic[18] = 0x00;  
        bufferDrvNic[19] = 0x00;  
        bufferDrvNic[20] = 0x00;  
        
        // Functions
        
        
        // Finish the function
        fsFileWrite(index, bufferDrvNic, 64);
        fsFileClose(index);
    }
    }
    
    
    return;
}
